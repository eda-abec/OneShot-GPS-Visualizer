<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>OpenStreetMap</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://openlayers.org/en/v6.3.0/css/ol.css" type="text/css">
    <script src="https://openlayers.org/en/v6.3.0/build/ol.js" type="text/javascript"></script>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
        </style>
    <script>
    
    // source: https://gist.github.com/Jezternz/c8e9fafc2c114e079829974e3764db75
    // with edits to change delimiter to semicolon
    const csvStringToArray = strData => {
        const objPattern = new RegExp(("(\\;|\\r?\\n|\\r|^)(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\\;\\r\\n]*))"),"gi");
        let arrMatches = null, arrData = [[]];
        while (arrMatches = objPattern.exec(strData)){
            if (arrMatches[1].length && arrMatches[1] !== ";")arrData.push([]);
            arrData[arrData.length - 1].push(arrMatches[2] ? 
                arrMatches[2].replace(new RegExp( "\"\"", "g" ), "\"") :
                arrMatches[3]);
        }
        return arrData;
    }
    
    
    //columns in .csv
    var DATE = 0;
    var SSID = 2;
    var LAT = 5;
    var LONG = 6;
    
    
    var map;
    var mapLat; //TODO assign by bounding box
    var mapLng;
    var zoom = 2;
    
    function initialize_map() {
        map = new ol.Map({
            target: "map",
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        url: "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([0, 0]),
                zoom: zoom
            })
        });
    }
    

    function add_map_point(ap) {
    
        var mark = document.createElement('img')
        mark.src = "dot.svg"
        mark.title = "SSID: " + ap[SSID] + "\n" +
                     "Date: " + ap[DATE]

        mark.style.width = "16px"
        var popup = new ol.Overlay({element: mark})
        
        popup.setPosition(ol.proj.transform([parseFloat(ap[LONG]), parseFloat(ap[LAT])], 'EPSG:4326', 'EPSG:3857'))
        map.addOverlay(popup)
    }

    function load(input) {
        file = input.files[0]
        
        var reader = new FileReader()
        reader.readAsText(file)
        
    //    var coords = []
            
        reader.onload = function() {
            data = csvStringToArray(reader.result, ";")
                
            data.forEach(line => {
             //   console.log(line)
                add_map_point(line)
                    
            //    coords.push([parseFloat(line[LAT]), parseFloat(line[LONG])])
            //    console.log([parseFloat(line[LAT]), parseFloat(line[LONG])])
            });
            
           /* zoom to bounding box, not working yet
            var ex = ol.extent.boundingExtent(coords)
            var areaExtent = ol.extent.applyTransform(ex, ol.proj.getTransform('EPSG:4326', 'EPSG:3857'))

            map.getView().transform(areaExtent)
            */
        };
    }
    </script>
</head>

<body onload="initialize_map();">
    <div id="box" style="width: 100vw; height: 5vh;">
        <input type="file" id="csvInput" onChange="load(this);"></input>
    </div>
    <div id="map" style="width: 100vw; height: 95vh;"></div>
</body>
</html>
